Iptables Role
=========

This role creates a new /etc/sysconfig/iptables file using a template, then copies it to the 
remote host and restarts the iptables service.

OS Versions:
- RHEL 5
-- This role does not function on RHEL 5.
- RHEL 6
-- This role functions on RHEL 6.
- RHEL 7
-- This role functions on RHEL 7, but ansible can configure RHEL 7 directly without the need of this role.

Requirements
------------

This role uses only core modules.

Role Variables
--------------

The iptables template builds its configuration off of four primary
variables (and one toggle):


Name                    | Type          | Purpose
------------------------|---------------|--------
`iptables_INPUT`        | list of dicts | Define the per-group section of the INPUT chain
`iptables_INPUT_footer` | list of dicts | Define the default section of the INPUT chain
`iptables_FORWARD`      | list of dicts | Define the per-group section of the FORWARD chain
`iptables_OUTPUT`       | list of dicts | Define the per-group section of the OUTPUT chain
`iptables_manage`       | boolean       | Define whether any tasks are executed

`iptables_INPUT` and `iptables_INPUT_footer` are concatenated together to form
the `INPUT` chain and the first entry in the `FORWARD` chain. All variables except
`iptables_INPUT_FOOTER` should be declared under `group_vars` and not in this file.

The allowed key/value pairs in
each dictionary are listed. Please see official iptables documentation
for a full listed of valid values.


Name          | Type                   | Contents
--------------|------------------------|----------
`interface`   | string                 | network device, e.g. lo or eth0
`source`      | string                 | source ip address or range
`sources`     | list                   | list of source ip addresses
`dest`        | string                 | destination ip address or range
`dests`       | list                   | list of destination ip addresses (comma delimited)
`srcrange`    | string                 | range of ipaddr sources such as '172.251.0.1-172.251.0.97'
`destrange`   | string                 | range of ipaddr dests such as '172.251.0.1-172.251.0.97'
`proto`       | string                 | tcp, udp, icmp, or all
`state`       | string                 | NEW, ESTABLISHED, RELATED, etc.
`match`       | string                 | tcp, udp, etc.
`dport`       | string                 | destination port or port range
`dports`      | comma-separated string | destination port list
`sport`       | string                 | source port or port range
`sports`      | comma-separated string | source port list
`response`    | string                 | ACCEPT, DROP, REJECT, etc.
`rejectwith`  | string                 | reject message, e.g. icmp-host-prohibited


By default, when you specify `dport`, both `proto` and `match` will set to tcp
and `response` will set to ACCEPT. Thus, the entry

```- { dport': 8080 }```

is equal to

```- { 'prot': 'tcp', 'match': 'tcp', 'dport': 8080, 'response': 'ACCEPT' }```

Additionally, if 'dport' and 'proto' are, set 'match' is set to be equal
to 'proto', such that:

``` - { 'dport': '53', 'proto': 'udp' }```

is equal to

```- { 'proto': 'udp', 'match': 'udp', 'dport': '53', 'response': 'ACCEPT'}```

Using the template in roles/iptables/templates/iptables.j2 with no addtional
`group_vars`, the following iptables configuration is generated:

```
## Generated by ansible
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
## Begin host-specific rules
## Begin common iptables rules
-A INPUT -p tcp -m tcp --dport 1556 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
```

Playbook Usage
----------------

Since the existing iptables playbook simply calls this role on a set of hosts, you can either change the configuration for that set of hosts or implement it in your playbook as below:

    - hosts: some hosts
      roles:
        - iptables

Actual configuration of non-default firewalls should be done in group_vars, as indicated above. Some examples...
```
iptables_INPUT:
  - { 'dport': 80 }
  - { 'dport': '443' }
  - { 'dport': '5671' }
  - { 'dport': '9090' }
```
will result in
```
## Generated by ansible
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
## Begin host-specific rules
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 5671 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 9090 -j ACCEPT
## Begin common iptables footer
-A INPUT -p tcp -m tcp --dport 1556 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
```
And
```
iptables_INPUT:
  - { 'dport': 8983 }
  - { 'dport': '6000:8000' }
  - { 'dport': '9100:9800' }
  - { 'source': '173.251.192.117/32', 'response': 'ACCEPT' }
  - { 'dest': '239.201.10.0/24', 'response': 'ACCEPT' }
  - { 'source': '173.251.192.44/32', 'dport': 631 }
```
will result in:
```
## Generated by ansible
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
## Begin host-specific rules
-A INPUT -p tcp -m tcp --dport 8983 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 6000:8000 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 9100:9800 -j ACCEPT
-A INPUT -s 173.251.192.117/32 -j ACCEPT
-A INPUT -d 239.201.10.0/24 -j ACCEPT
-A INPUT -s 173.251.192.44/32 -p tcp -m tcp --dport 631 -j ACCEPT
## Begin common iptables footer
-A INPUT -p tcp -m tcp --dport 1556 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
```

For an example of `sources` and `dests`:

```
iptables_INPUT:
  - 'dport': '9200'
    'sources':
      - '173.251.193.166'
      - '173.251.193.167'
      - '173.251.193.168'
      - '173.251.193.178'
      - '173.251.193.179'
  - 'dport': '9300'
    'sources':
      - '173.251.193.166'
      - '173.251.193.167'
      - '173.251.193.168'
      - '173.251.193.178'
      - '173.251.193.179'
```
results in...
```
## Generated by ansible
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
## Begin host-specific rules
-A INPUT -s 173.251.193.166,173.251.193.167,173.251.193.168,173.251.193.178,173.251.193.179 -p tcp -m tcp --dport 9200 -j ACCEPT
-A INPUT -s 173.251.193.166,173.251.193.167,173.251.193.168,173.251.193.178,173.251.193.179 -p tcp -m tcp --dport 9300 -j ACCEPT
## Begin common iptables rules
-A INPUT -p tcp -m tcp --dport 1556 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
```

# License

Roger Nem. All rights reserved

# Author Information

[Roger Nem](https://www.linkedin.com/in/rogertn)